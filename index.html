<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Jarvis</title>
  <style>
    * { margin: 0; padding: 0; box-sizing: border-box; }
    
    body {
      background: #000;
      min-height: 100vh;
      overflow: hidden;
      font-family: 'Segoe UI', system-ui, sans-serif;
    }
    
    /* Любой клик активирует */
    .container {
      position: relative;
      z-index: 10;
      min-height: 100vh;
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      background: radial-gradient(ellipse at center, 
        rgba(0, 40, 80, 0.6) 0%, 
        #000 100%
      );
    }
    
    .core-wrapper {
      position: relative;
      width: 300px;
      height: 300px;
      display: flex;
      align-items: center;
      justify-content: center;
      cursor: pointer;
    }
    
    .orbit {
      position: absolute;
      border: 1px solid rgba(0, 212, 255, 0.15);
      border-radius: 50%;
      top: 50%;
      left: 50%;
      transform: translate(-50%, -50%);
      animation: spin linear infinite;
    }
    
    .orbit-1 { width: 280px; height: 280px; animation-duration: 15s; }
    .orbit-2 { width: 220px; height: 220px; animation-duration: 10s; animation-direction: reverse; }
    .orbit-3 { width: 160px; height: 160px; animation-duration: 7s; }
    
    @keyframes spin { from { transform: translate(-50%, -50%) rotate(0deg); } to { transform: translate(-50%, -50%) rotate(360deg); } }
    
    .core {
      position: relative;
      width: 90px;
      height: 90px;
      z-index: 20;
    }
    
    .core-inner {
      width: 100%;
      height: 100%;
      border-radius: 50%;
      background: radial-gradient(circle at 30% 30%, #00d4ff, #0066cc);
      box-shadow: 0 0 40px rgba(0, 212, 255, 0.5);
      animation: breathe 3s ease-in-out infinite;
      transition: all 0.3s;
    }
    
    @keyframes breathe { 0%, 100% { transform: scale(1); } 50% { transform: scale(1.05); } }
    
    .core.listening .core-inner {
      background: #00ff88;
      box-shadow: 0 0 60px rgba(0, 255, 136, 0.6);
      animation: pulse 0.5s infinite;
    }
    
    .core.thinking .core-inner {
      background: #ffaa00;
      animation: spin-fast 0.8s linear infinite;
    }
    
    .core.speaking .core-inner {
      background: #ff66ff;
      box-shadow: 0 0 60px rgba(255, 102, 255, 0.6);
      animation: shake 0.2s infinite;
    }
    
    @keyframes pulse { 0%, 100% { transform: scale(1); } 50% { transform: scale(1.15); } }
    @keyframes spin-fast { from { transform: rotate(0deg); } to { transform: rotate(360deg); } }
    @keyframes shake { 0%, 100% { transform: translate(0, 0); } 25% { transform: translate(2px, 2px); } 75% { transform: translate(-2px, -2px); } }
    
    .status {
      position: absolute;
      bottom: 80px;
      font-size: 12px;
      text-transform: uppercase;
      letter-spacing: 3px;
      color: #00d4ff;
      transition: all 0.3s;
    }
    
    .status.quick { color: #00ff88; text-shadow: 0 0 20px rgba(0, 255, 136, 0.8); }
    
    .bubble {
      position: absolute;
      top: 60px;
      left: 50%;
      transform: translateX(-50%);
      max-width: 85%;
      background: rgba(0, 20, 40, 0.9);
      border: 1px solid rgba(0, 212, 255, 0.3);
      border-radius: 12px;
      padding: 10px 15px;
      color: #fff;
      font-size: 14px;
      opacity: 0;
      transition: opacity 0.2s;
      text-align: center;
    }
    
    .bubble.show { opacity: 1; }
    
    .first-touch {
      position: fixed;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background: rgba(0, 0, 0, 0.8);
      display: flex;
      align-items: center;
      justify-content: center;
      z-index: 1000;
      color: #00d4ff;
      font-size: 14px;
      text-transform: uppercase;
      letter-spacing: 3px;
      cursor: pointer;
      transition: opacity 0.5s;
    }
    
    .first-touch.hidden { opacity: 0; pointer-events: none; }
  </style>
</head>
<body>
  <div class="first-touch" id="firstTouch" onclick="initSystem()">
    Нажмите везде для активации
  </div>
  
  <div class="container">
    <div class="bubble" id="bubble"></div>
    
    <div class="core-wrapper" id="coreWrapper">
      <div class="orbit orbit-1"></div>
      <div class="orbit orbit-2"></div>
      <div class="orbit orbit-3"></div>
      
      <div class="core" id="core">
        <div class="core-inner"></div>
      </div>
    </div>
    
    <div class="status" id="status">Ожидание...</div>
  </div>

  <script>
    const API_URL = 'https://jarvis-virid-one.vercel.app/api/ask';
    
    const core = document.getElementById('core');
    const status = document.getElementById('status');
    const bubble = document.getElementById('bubble');
    const firstTouch = document.getElementById('firstTouch');
    const coreWrapper = document.getElementById('coreWrapper');
    
    let isProcessing = false;
    let voices = [];
    let recognition = null;
    let systemReady = false;
    
    // Инициализация по первому касанию
    function initSystem() {
      firstTouch.classList.add('hidden');
      systemReady = true;
      
      // Разблокируем аудио
      const silent = new SpeechSynthesisUtterance('');
      speechSynthesis.speak(silent);
      speechSynthesis.cancel();
      
      // Загружаем голоса
      voices = speechSynthesis.getVoices();
      if (voices.length === 0) {
        speechSynthesis.onvoiceschanged = () => {
          voices = speechSynthesis.getVoices();
        };
      }
      
      // Запускаем распознавание
      startListening();
      
      status.textContent = 'Слушаю...';
      status.classList.add('quick');
    }
    
    function startListening() {
      if (!('webkitSpeechRecognition' in window)) {
        status.textContent = 'Браузер не поддерживает голос';
        return;
      }
      
      const SpeechRecognition = window.SpeechRecognition || window.webkitSpeechRecognition;
      recognition = new SpeechRecognition();
      recognition.lang = 'ru-RU';
      recognition.continuous = true;
      recognition.interimResults = false; // Только финальные — быстрее
      
      recognition.onstart = () => {
        status.textContent = 'Слушаю...';
      };
      
      recognition.onresult = (e) => {
        const text = e.results[0][0].transcript.toLowerCase().trim();
        console.log('Услышал:', text);
        
        // БЫСТРАЯ проверка — просто содержит "джарвис"
        if (!isProcessing && text.includes('джарвис')) {
          const command = text.replace(/джарвис/g, '').trim();
          
          // Мгновенная реакция
          core.className = 'core listening';
          
          if (command.length > 2) {
            // Небольшая задержка для эффекта "понимания"
            setTimeout(() => processCommand(command), 200);
          } else {
            status.textContent = 'Да, сэр?';
            speak('Да, сэр?');
            setTimeout(() => {
              if (!isProcessing) {
                core.className = 'core';
                status.textContent = 'Слушаю...';
              }
            }, 3000);
          }
        }
      };
      
      recognition.onerror = (e) => {
        console.log('Ошибка:', e.error);
        // Быстрый перезапуск
        setTimeout(() => {
          if (!isProcessing) recognition.start();
        }, 200);
      };
      
      recognition.onend = () => {
        if (!isProcessing) recognition.start();
      };
      
      recognition.start();
    }
    
    // БЫСТРАЯ обработка
    async function processCommand(text) {
      isProcessing = true;
      
      // Мгновенная визуальная реакция
      core.className = 'core thinking';
      status.textContent = 'Думаю...';
      showBubble(text);
      
      // Параллельно запускаем запрос
      const fetchPromise = fetch(API_URL, {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ prompt: text })
      });
      
      // Таймаут — не ждём долго
      const timeoutPromise = new Promise((_, reject) => 
        setTimeout(() => reject(new Error('Timeout')), 5000)
      );
      
      try {
        const res = await Promise.race([fetchPromise, timeoutPromise]);
        
        if (!res.ok) throw new Error('HTTP ' + res.status);
        
        const data = await res.json();
        const answer = data.response;
        
        // Мгновенный ответ
        showBubble(answer);
        core.className = 'core speaking';
        status.textContent = 'Говорю...';
        
        // Говорим сразу — не ждём
        speak(answer);
        
      } catch (err) {
        console.error(err);
        // Быстрый fallback
        const fallback = 'Понял, сэр. Выполняю.';
        showBubble(fallback);
        speak(fallback);
        setTimeout(reset, 2000);
      }
    }
    
    function showBubble(text) {
      bubble.textContent = text;
      bubble.classList.add('show');
    }
    
    // УЛЬТРА-БЫСТРЫЙ голос
    function speak(text) {
      // Прерываем всё
      speechSynthesis.cancel();
      
      // Берём первый доступный голос — не тратим время на поиск
      let voice = speechSynthesis.getVoices()[0];
      const voices = speechSynthesis.getVoices();
      
      // Быстрый поиск русского
      for (let v of voices) {
        if (v.lang.includes('ru')) {
          voice = v;
          break; // Первый попавшийся — быстрее
        }
      }
      
      const u = new SpeechSynthesisUtterance(text);
      u.lang = 'ru-RU';
      u.rate = 1.1; // БЫСТРЕЕ — как живой
      u.pitch = 0.8;
      u.volume = 1;
      
      if (voice) u.voice = voice;
      
      u.onstart = () => {
        core.className = 'core speaking';
      };
      
      u.onend = () => {
        reset();
        setTimeout(() => bubble.classList.remove('show'), 1000);
      };
      
      // Небольшие паузы для естественности
      u.text = text.replace(/([.!?])/g, '$1 ').replace(/,/g, ', ');
      
      speechSynthesis.speak(u);
    }
    
    function reset() {
      isProcessing = false;
      core.className = 'core';
      status.textContent = 'Слушаю...';
      if (recognition) recognition.start();
    }
    
    // Ручной запуск по клику на шар
    coreWrapper.addEventListener('click', () => {
      if (!systemReady) {
        initSystem();
        return;
      }
      
      if (isProcessing) return;
      
      core.className = 'core listening';
      status.textContent = 'Да, сэр?';
      speak('Да, сэр?');
      
      setTimeout(() => {
        if (!isProcessing) {
          core.className = 'core';
          status.textContent = 'Слушаю...';
        }
      }, 3000);
    });
    
    // Также активируем по любому клику на экране
    document.addEventListener('click', (e) => {
      if (!systemReady && e.target !== coreWrapper && !coreWrapper.contains(e.target)) {
        initSystem();
      }
    }, { once: true });
  </script>
</body>
</html>
