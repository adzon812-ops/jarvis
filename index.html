<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Jarvis</title>
  <style>
    * { margin: 0; padding: 0; box-sizing: border-box; }
    
    body {
      background: #000;
      min-height: 100vh;
      overflow: hidden;
      font-family: 'Segoe UI', system-ui, sans-serif;
    }
    
    /* Живой фон — неоновые волны */
    .neon-waves {
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      z-index: 1;
    }
    
    .wave {
      position: absolute;
      width: 200%;
      height: 200%;
      top: -50%;
      left: -50%;
      background: radial-gradient(ellipse at center,
        transparent 0%,
        rgba(0, 212, 255, 0.1) 30%,
        transparent 60%
      );
      animation: wave-rotate 20s linear infinite;
    }
    
    .wave:nth-child(2) {
      background: radial-gradient(ellipse at center,
        transparent 0%,
        rgba(0, 255, 136, 0.08) 40%,
        transparent 70%
      );
      animation-duration: 25s;
      animation-direction: reverse;
    }
    
    .wave:nth-child(3) {
      background: radial-gradient(ellipse at center,
        transparent 0%,
        rgba(255, 0, 255, 0.06) 35%,
        transparent 65%
      );
      animation-duration: 15s;
    }
    
    @keyframes wave-rotate {
      from { transform: rotate(0deg); }
      to { transform: rotate(360deg); }
    }
    
    /* Плавающие кристаллы */
    .crystals {
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      pointer-events: none;
      z-index: 2;
    }
    
    .crystal {
      position: absolute;
      width: 0;
      height: 0;
      border-left: 15px solid transparent;
      border-right: 15px solid transparent;
      border-bottom: 30px solid rgba(0, 212, 255, 0.3);
      filter: drop-shadow(0 0 10px rgba(0, 212, 255, 0.5));
      animation: float-crystal 12s ease-in-out infinite;
    }
    
    @keyframes float-crystal {
      0%, 100% { 
        transform: translateY(0) rotate(0deg); 
        opacity: 0.3;
      }
      50% { 
        transform: translateY(-50px) rotate(180deg); 
        opacity: 0.8;
      }
    }
    
    /* Энергетические линии */
    .energy-lines {
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      pointer-events: none;
      z-index: 3;
    }
    
    .energy-line {
      position: absolute;
      height: 2px;
      background: linear-gradient(90deg, 
        transparent, 
        rgba(0, 212, 255, 0.6), 
        transparent
      );
      animation: energy-pulse 3s ease-in-out infinite;
    }
    
    @keyframes energy-pulse {
      0%, 100% { opacity: 0.2; transform: scaleX(0.5); }
      50% { opacity: 1; transform: scaleX(1); }
    }
    
    /* Частицы данных */
    .data-particles {
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      pointer-events: none;
      z-index: 4;
    }
    
    .data-particle {
      position: absolute;
      font-size: 10px;
      color: rgba(0, 212, 255, 0.4);
      font-family: monospace;
      animation: data-fall 10s linear infinite;
    }
    
    @keyframes data-fall {
      0% { transform: translateY(-100px); opacity: 0; }
      10% { opacity: 0.6; }
      90% { opacity: 0.6; }
      100% { transform: translateY(100vh); opacity: 0; }
    }
    
    /* Голографический интерфейс */
    .holo-interface {
      position: relative;
      z-index: 10;
      min-height: 100vh;
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      padding: 20px;
    }
    
    /* Индикатор активности — вместо шара */
    .activity-ring {
      width: 150px;
      height: 150px;
      border-radius: 50%;
      border: 2px solid rgba(0, 212, 255, 0.3);
      position: relative;
      display: flex;
      align-items: center;
      justify-content: center;
    }
    
    .activity-ring::before,
    .activity-ring::after {
      content: '';
      position: absolute;
      border-radius: 50%;
      border: 2px solid transparent;
      border-top-color: #00d4ff;
      border-right-color: #00d4ff;
    }
    
    .activity-ring::before {
      width: 120px;
      height: 120px;
      animation: spin 4s linear infinite;
    }
    
    .activity-ring::after {
      width: 90px;
      height: 90px;
      animation: spin 3s linear infinite reverse;
    }
    
    /* Состояния активности */
    .activity-ring.listening {
      border-color: rgba(0, 255, 136, 0.5);
      animation: pulse-ring 1s ease-in-out infinite;
    }
    
    .activity-ring.listening::before,
    .activity-ring.listening::after {
      border-top-color: #00ff88;
      border-right-color: #00ff88;
    }
    
    .activity-ring.thinking {
      border-color: rgba(255, 170, 0, 0.5);
    }
    
    .activity-ring.thinking::before,
    .activity-ring.thinking::after {
      border-top-color: #ffaa00;
      border-right-color: #ffaa00;
      animation-duration: 0.5s;
    }
    
    .activity-ring.speaking {
      border-color: rgba(255, 102, 255, 0.5);
      animation: speak-pulse 0.3s ease-in-out infinite;
    }
    
    .activity-ring.speaking::before,
    .activity-ring.speaking::after {
      border-top-color: #ff66ff;
      border-right-color: #ff66ff;
    }
    
    @keyframes pulse-ring {
      0%, 100% { transform: scale(1); opacity: 1; }
      50% { transform: scale(1.1); opacity: 0.8; }
    }
    
    @keyframes speak-pulse {
      0%, 100% { transform: scale(1); }
      50% { transform: scale(1.05); }
    }
    
    /* Центральная точка */
    .center-dot {
      width: 20px;
      height: 20px;
      background: #00d4ff;
      border-radius: 50%;
      box-shadow: 0 0 30px #00d4ff, 0 0 60px #00d4ff;
      animation: dot-pulse 2s ease-in-out infinite;
    }
    
    @keyframes dot-pulse {
      0%, 100% { transform: scale(1); opacity: 1; }
      50% { transform: scale(1.3); opacity: 0.8; }
    }
    
    /* Текстовый вывод */
    .holo-display {
      margin-top: 40px;
      width: 90%;
      max-width: 600px;
      min-height: 100px;
      background: rgba(0, 20, 40, 0.6);
      border: 1px solid rgba(0, 212, 255, 0.3);
      border-radius: 10px;
      padding: 20px;
      color: #00d4ff;
      font-size: 16px;
      line-height: 1.6;
      text-align: center;
      backdrop-filter: blur(10px);
      box-shadow: 0 0 30px rgba(0, 212, 255, 0.2);
      opacity: 0;
      transition: opacity 0.3s;
    }
    
    .holo-display.active {
      opacity: 1;
    }
    
    .holo-display.user {
      color: #00ff88;
      border-color: rgba(0, 255, 136, 0.3);
      box-shadow: 0 0 30px rgba(0, 255, 136, 0.2);
    }
    
    .holo-display.jarvis {
      color: #ff66ff;
      border-color: rgba(255, 102, 255, 0.3);
      box-shadow: 0 0 30px rgba(255, 102, 255, 0.2);
    }
    
    /* Статус */
    .status-line {
      margin-top: 30px;
      font-size: 12px;
      color: rgba(0, 212, 255, 0.6);
      text-transform: uppercase;
      letter-spacing: 4px;
    }
    
    /* Подсказка */
    .hint {
      position: fixed;
      bottom: 20px;
      left: 50%;
      transform: translateX(-50%);
      color: rgba(255, 255, 255, 0.3);
      font-size: 11px;
      text-align: center;
    }
    
    /* Активация по касанию */
    .touch-activate {
      position: fixed;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background: rgba(0, 0, 0, 0.9);
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      z-index: 1000;
      color: #00d4ff;
      transition: opacity 0.5s;
    }
    
    .touch-activate.hidden {
      opacity: 0;
      pointer-events: none;
    }
    
    .activate-text {
      font-size: 16px;
      text-transform: uppercase;
      letter-spacing: 3px;
      margin-bottom: 20px;
    }
    
    .activate-btn {
      padding: 20px 40px;
      background: transparent;
      border: 2px solid #00d4ff;
      color: #00d4ff;
      font-size: 14px;
      text-transform: uppercase;
      letter-spacing: 2px;
      cursor: pointer;
      border-radius: 30px;
      animation: btn-pulse 2s infinite;
    }
    
    @keyframes btn-pulse {
      0%, 100% { box-shadow: 0 0 20px rgba(0, 212, 255, 0.3); }
      50% { box-shadow: 0 0 40px rgba(0, 212, 255, 0.6); }
    }
  </style>
</head>
<body>
  <!-- Активация -->
  <div class="touch-activate" id="touchActivate">
    <div class="activate-text">Коснитесь экрана для активации</div>
    <button class="activate-btn" onclick="activate()">Активировать Джарвиса</button>
  </div>
  
  <!-- Фон -->
  <div class="neon-waves">
    <div class="wave"></div>
    <div class="wave"></div>
    <div class="wave"></div>
  </div>
  
  <div class="crystals" id="crystals"></div>
  
  <div class="energy-lines" id="energyLines"></div>
  
  <div class="data-particles" id="dataParticles"></div>
  
  <!-- Интерфейс -->
  <div class="holo-interface">
    <div class="activity-ring" id="activityRing">
      <div class="center-dot"></div>
    </div>
    
    <div class="holo-display" id="holoDisplay"></div>
    
    <div class="status-line" id="statusLine">СИСТЕМА ОЖИДАНИЯ</div>
  </div>
  
  <div class="hint">Говорите естественно • Не нужно кричать "Джарвис"</div>

  <script>
    const API_URL = 'https://jarvis-virid-one.vercel.app/api/ask';
    
    const activityRing = document.getElementById('activityRing');
    const holoDisplay = document.getElementById('holoDisplay');
    const statusLine = document.getElementById('statusLine');
    const touchActivate = document.getElementById('touchActivate');
    
    let isProcessing = false;
    let recognition = null;
    let lastActivity = Date.now();
    let silenceTimeout = null;
    
    // Создаём кристаллы
    const crystals = document.getElementById('crystals');
    for (let i = 0; i < 8; i++) {
      const c = document.createElement('div');
      c.className = 'crystal';
      c.style.left = (10 + Math.random() * 80) + '%';
      c.style.top = (10 + Math.random() * 80) + '%';
      c.style.animationDelay = (Math.random() * 5) + 's';
      c.style.animationDuration = (10 + Math.random() * 5) + 's';
      crystals.appendChild(c);
    }
    
    // Создаём энергетические линии
    const energyLines = document.getElementById('energyLines');
    for (let i = 0; i < 5; i++) {
      const line = document.createElement('div');
      line.className = 'energy-line';
      line.style.top = (20 + i * 15) + '%';
      line.style.left = '0';
      line.style.width = '100%';
      line.style.animationDelay = (i * 0.5) + 's';
      energyLines.appendChild(line);
    }
    
    // Создаём частицы данных
    const dataParticles = document.getElementById('dataParticles');
    const symbols = '01アイウエオカキクケコ';
    for (let i = 0; i < 20; i++) {
      const p = document.createElement('div');
      p.className = 'data-particle';
      p.textContent = symbols[Math.floor(Math.random() * symbols.length)];
      p.style.left = Math.random() * 100 + '%';
      p.style.animationDelay = Math.random() * 10 + 's';
      p.style.animationDuration = (8 + Math.random() * 6) + 's';
      dataParticles.appendChild(p);
    }
    
    // Активация
    function activate() {
      touchActivate.classList.add('hidden');
      
      // Разблокируем аудио
      const silent = new Audio();
      silent.play().catch(() => {});
      
      // Инициализируем голос
      speechSynthesis.getVoices();
      
      // Запускаем распознавание
      startListening();
      
      statusLine.textContent = 'СЛУШАЮ';
      showText('Система активирована. Говорите, сэр.', 'jarvis');
      speak('Джарвис онлайн. Готов к работе, сэр.');
    }
    
    // Распознавание — умное, без постоянного "Джарвис"
    function startListening() {
      if (!('webkitSpeechRecognition' in window)) {
        statusLine.textContent = 'ГОЛОСОВОЙ ВВОД НЕДОСТУПЕН';
        return;
      }
      
      const SpeechRecognition = window.SpeechRecognition || window.webkitSpeechRecognition;
      recognition = new SpeechRecognition();
      recognition.lang = 'ru-RU';
      recognition.continuous = true;
      recognition.interimResults = false;
      
      // Чувствительность — слушаем тихий голос
      // (в реальности зависит от микрофона, но пробуем)
      
      recognition.onstart = () => {
        statusLine.textContent = 'СЛУШАЮ';
        activityRing.className = 'activity-ring';
      };
      
      recognition.onresult = (e) => {
        const text = e.results[0][0].transcript.trim();
        const confidence = e.results[0][0].confidence;
        
        console.log('Услышал:', text, 'уверенность:', confidence);
        
        // Обновляем активность
        lastActivity = Date.now();
        clearTimeout(silenceTimeout);
        
        // Проверяем — это команда или болтовня?
        // Если длинное предложение и уверенность высокая — обрабатываем
        if (text.length > 3 && confidence > 0.5 && !isProcessing) {
          // Проверяем ключевые слова для уверенности
          const isCommand = /^(джарвис|скажи|что|как|почему|зачем|включи|выключи|открой|закрой|покажи|найди|расскажи|объясни|помоги|спасибо|привет|до свидания)/i.test(text.toLowerCase());
          
          // Если явно обращаются или длинная фраза — отвечаем
          if (isCommand || text.length > 10) {
            processInput(text);
          }
        }
      };
      
      recognition.onerror = (e) => {
        console.log('Ошибка:', e.error);
        // Тихо перезапускаем
        setTimeout(() => {
          if (!isProcessing) recognition.start();
        }, 200);
      };
      
      recognition.onend = () => {
        if (!isProcessing) recognition.start();
      };
      
      recognition.start();
      
      // Периодически проверяем тишину — можем спросить "Вы тут, сэр?"
      silenceTimeout = setInterval(() => {
        const idle = Date.now() - lastActivity;
        if (idle > 60000 && !isProcessing) { // 1 минута тишины
          speak('Сэр, вы тут?');
          lastActivity = Date.now();
        }
      }, 60000);
    }
    
    async function processInput(text) {
      isProcessing = true;
      activityRing.className = 'activity-ring thinking';
      statusLine.textContent = 'ОБРАБОТКА';
      showText(text, 'user');
      
      try {
        const res = await fetch(API_URL, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ prompt: text })
        });
        
        const data = await res.json();
        const answer = data.response;
        
        showText(answer, 'jarvis');
        
        // Если есть ElevenLabs аудио — играем его
        if (data.audio) {
          playElevenLabs(data.audio);
        } else {
          // Fallback — браузерный, но энергичный
          speakEnergetic(answer);
        }
        
      } catch (err) {
        console.error(err);
        showText('Ошибка связи, сэр', 'jarvis');
        speakEnergetic('Связь прервана, сэр');
        reset();
      }
    }
    
    function showText(text, who) {
      holoDisplay.textContent = text;
      holoDisplay.className = 'holo-display active ' + who;
    }
    
    function playElevenLabs(audioUrl) {
      const audio = new Audio(audioUrl);
      
      audio.onplay = () => {
        activityRing.className = 'activity-ring speaking';
        statusLine.textContent = 'ГОВОРЮ';
      };
      
      audio.onended = () => {
        reset();
      };
      
      audio.onerror = () => {
        // Если не заработало — fallback
        speakEnergetic(holoDisplay.textContent);
      };
      
      audio.play();
    }
    
    // ЭНЕРГИЧНЫЙ голос — не умирающий
    function speakEnergetic(text) {
      speechSynthesis.cancel();
      
      const voices = speechSynthesis.getVoices();
      let voice = voices.find(v => v.lang.includes('ru'));
      
      const u = new SpeechSynthesisUtterance(text);
      u.lang = 'ru-RU';
      
      // ЭНЕРГИЯ: быстрее, выше тон (но не женский), громче
      u.rate = 1.15;        // Быстро, но не robotic
      u.pitch = 0.85;       // Высокий для мужского = энергичный
      u.volume = 1;
      
      if (voice) u.voice = voice;
      
      u.onstart = () => {
        activityRing.className = 'activity-ring speaking';
        statusLine.textContent = 'ГОВОРЮ';
      };
      
      u.onend = () => {
        reset();
      };
      
      // Добавляем восклицания для энергичности
      let energeticText = text
        .replace(/\./g, '!')  // Точки -> восклицания
        .replace(/,/g, '...'); // Паузы для драматичности
      
      // Но не переборщим
      if (energeticText.split('!').length > 3) {
        energeticText = text; // Оставляем как есть
      }
      
      u.text = energeticText;
      
      speechSynthesis.speak(u);
    }
    
    function reset() {
      isProcessing = false;
      activityRing.className = 'activity-ring';
      statusLine.textContent = 'СЛУШАЮ';
      lastActivity = Date.now();
      
      // Не скрываем текст сразу — пусть висит
      setTimeout(() => {
        if (!isProcessing) {
          holoDisplay.classList.remove('active');
        }
      }, 5000);
    }
    
    // Также активируем по любому клику
    document.addEventListener('click', () => {
      if (touchActivate.classList.contains('hidden')) return;
      activate();
    }, { once: true });
  </script>
</body>
</html>
